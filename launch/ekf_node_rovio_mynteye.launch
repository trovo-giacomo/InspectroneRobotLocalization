<launch>
  <arg name="record_bag" default="true" />
  <arg name="display_rviz" default="true" />
  <!-- 
    1st 2022-02-02-14-03-37
    2nd 2022-02-02-14-08-19
    3rd 2022-02-02-14-11-58
     -->
  <arg name="input_bag_name" default="2022-02-02-14-11-58.bag" />
  <arg name="output_bag_name" default="rovio_mynteye_2_imu_fused_md_02-14-11-58.bag" />
  <param name="use_sim_time" value="true" />
  
  <!-- Play bag -->
  <node pkg="rosbag" type="play" name="player" output="screen" args="/home/giacomo/inspectrone_ws/bags/inspectrone/$(arg input_bag_name) --clock"/>

  <!-- Start rovio -->
  <include file="$(find rovio)/launch/rovio_node_mynteye.launch" />

  <!-- De-compress left and right image -->
  <!-- rosrun image_transport republish compressed in:=/mynteye/left/image_raw raw out:=/mynteye/left/image_raw -->
  <node
    pkg="image_transport"
    type="republish"
    name="republish_left"
    args="compressed in:=/mynteye/left/image_raw raw out:=/mynteye/left/image_raw"
    output="log"
  />

  <!-- rosrun image_transport republish compressed in:=/mynteye/right/image_raw raw out:=/mynteye/right/image_raw -->
  <node
    pkg="image_transport"
    type="republish"
    name="republish_right"
    args="compressed in:=/mynteye/right/image_raw raw out:=/mynteye/right/image_raw"
    output="log" />

  <!-- Run transform between 'abs_correction' and 'odom' (realsense) -->
  <!--<node 
    pkg="inspectrone_test"
    type="publish_tf_mynteye_odom_realsense.py"
    name="publish_tf_mynteye_odom_realsense"
    output="log"
    />-->

  <!-- Robot Localization - EKF node --> 
  <node name="ekf_odom" pkg="robot_localization" type="ekf_localization_node" clear_params="true">
        
        <param name="sensor_timeout" value="0.1"/>
        <!--param name="map_frame" value="map" /-->
        <param name="odom_frame" value="odom" />
        <param name="base_link_frame" value="base_link" />
        <param name="world_frame" value="odom" />

        <param name="odom0" value="camera/odom/sample" />
        <param name="odom1" value="rovio/odometry" />
        <param name="imu0"  value="mavros/imu/data" /> <!-- more precise covariance 10^-7 -->
        <param name="imu1"  value="camera/imu" /> <!-- covariance 10^-2 -->

        <!-- X,Y,Z,roll,pitch,yaw,X˙,Y˙,Z˙,roll˙,pitch˙,yaw˙,X¨,Y¨,Z¨)-->
        <rosparam param="odom0_config">[false, false, false,
                                        true, true, true,
                                        true, true, true,
                                        true, true, true,
                                        false, false, false]</rosparam>

        <rosparam param="odom1_config">[false, false, false,
                                        true, true, true,
                                        true, true, true,
                                        false, false, false,
                                        false, false, false]</rosparam>
        <rosparam param="imu0_config">[false, false, false,
                                        false, false, false,
                                        false, false, false,
                                        true, true, true,
                                        true, true, true]</rosparam>
        <rosparam param="imu1_config">[false, false, false,
                                        false, false, false,
                                        false, false, false,
                                        true, true, true,
                                        true, true, true]</rosparam>

        <param name="odom0_differential" value="false" />
        <param name="odom1_differential" value="true" /> <!-- if set to false jumbs in the orientation of the camera -->
        <param name="imu0_differential" value="false" />
        <param name="imu1_differential" value="false" /> <!-- works better when set to false -->
      
        <param name="odom1_pose_rejection_threshold" value="1.5" />
        <param name="odom1_twist_rejection_threshold" value="1.5" />
        <param name="imu0_pose_rejection_threshold" value="7" />
        <param name="imu0_angular_velocity_rejection_threshold" value="15" />
        <param name="imu0_linear_acceleration_rejection_threshold" value="15" />
        <param name="imu1_pose_rejection_threshold" value="7" />
        <param name="imu1_angular_velocity_rejection_threshold" value="15" />
        <param name="imu1_linear_acceleration_rejection_threshold" value="15" />

        <param name="imu0_remove_gravitational_acceleration"  value="true"/>
        <param name="imu1_remove_gravitational_acceleration"  value="true"/>

        <param name="odom0_relative" value="false" />
        <param name="odom1_relative" value="false" />
        <param name="imu0_relative" value="false" />
        <param name="imu1_relative" value="false" />

        <param name="odom0_queue_size" value="50" />
        <param name="odom1_queue_size" value="50" />
        <param name="imu0_queue_size" value="50" />
        <param name="imu1_queue_size" value="50" />

        <param name="print_diagnostics" value="false"/>

        <param name="debug"           value="false"/>
        <param name="debug_out_file"  value="debug_ekf_localization.txt"/>
        
        <!-- If true, will dynamically scale the process_noise_covariance based on the robot’s velocity. This is useful, e.g., when you want your robot’s estimate error covariance to stop growing when the robot is stationary.-->
        <param name="dynamic_process_noise_covariance" value="true" />

        <!-- The process noise covariance, commonly denoted Q, is used to model uncertainty in the prediction stage of the filtering algorithms. In general, the larger the value for Q relative to the variance for a given variable in an input message, the faster the filter will converge to the value in the measurement.-->
        <rosparam param="process_noise_covariance">[1e-3, 0,    0,    0,    0,    0,    0,     0,     0,    0,    0,    0,    0,    0,    0,
                                                    0,    1e-3, 0,    0,    0,    0,    0,     0,     0,    0,    0,    0,    0,    0,    0,
                                                    0,    0,    1e-3, 0,    0,    0,    0,     0,     0,    0,    0,    0,    0,    0,    0,
                                                    0,    0,    0,    1e-2 ,0,    0,    0,     0,     0,    0,    0,    0,    0,    0,    0,
                                                    0,    0,    0,    0,    1e-2, 0,    0,     0,     0,    0,    0,    0,    0,    0,    0,
                                                    0,    0,    0,    0,    0,    5e-1, 0,     0,     0,    0,    0,    0,    0,    0,    0,
                                                    0,    0,    0,    0,    0,    0,    5e-1,  0,     0,    0,    0,    0,    0,    0,    0,
                                                    0,    0,    0,    0,    0,    0,    0,     5e-1,  0,    0,    0,    0,    0,    0,    0,
                                                    0,    0,    0,    0,    0,    0,    0,     0,     5e-1, 0,    0,    0,    0,    0,    0,
                                                    0,    0,    0,    0,    0,    0,    0,     0,     0,    1e-1, 0,    0,    0,    0,    0,
                                                    0,    0,    0,    0,    0,    0,    0,     0,     0,    0,    1e-1, 0,    0,    0,    0,
                                                    0,    0,    0,    0,    0,    0,    0,     0,     0,    0,    0,    5e-1, 0,    0,    0,
                                                    0,    0,    0,    0,    0,    0,    0,     0,     0,    0,    0,    0,    5e-1,  0,    0,
                                                    0,    0,    0,    0,    0,    0,    0,     0,     0,    0,    0,    0,    0,    5e-1,  0,
                                                    0,    0,    0,    0,    0,    0,    0,     0,     0,    0,    0,    0,    0,    0,    5e-1]</rosparam>
      <!-- initial P -->
      <rosparam param="initial_estimate_covariance">[1e-12, 0,    0,    0,    0,    0,    0,    0,    0,    0,     0,     0,     0,    0,    0,
                                                     0,    1e-12, 0,    0,    0,    0,    0,    0,    0,    0,     0,     0,     0,    0,    0,
                                                     0,    0,    1e-12, 0,    0,    0,    0,    0,    0,    0,     0,     0,     0,    0,    0,
                                                     0,    0,    0,    1e-9, 0,    0,    0,    0,    0,    0,     0,     0,     0,    0,    0,
                                                     0,    0,    0,    0,    1e-9, 0,    0,    0,    0,    0,     0,     0,     0,    0,    0,
                                                     0,    0,    0,    0,    0,    1e-9, 0,    0,    0,    0,     0,     0,     0,    0,    0,
                                                     0,    0,    0,    0,    0,    0,    1e-9, 0,    0,    0,     0,     0,     0,    0,    0,
                                                     0,    0,    0,    0,    0,    0,    0,    1e-9, 0,    0,     0,     0,     0,    0,    0,
                                                     0,    0,    0,    0,    0,    0,    0,    0,    1e-9, 0,     0,     0,     0,    0,    0,
                                                     0,    0,    0,    0,    0,    0,    0,    0,    0,    1e-9,  0,     0,     0,    0,    0,
                                                     0,    0,    0,    0,    0,    0,    0,    0,    0,    0,     1e-9,  0,     0,    0,    0,
                                                     0,    0,    0,    0,    0,    0,    0,    0,    0,    0,     0,     1e-9,  0,    0,    0,
                                                     0,    0,    0,    0,    0,    0,    0,    0,    0,    0,     0,     0,     1e-12, 0,    0,
                                                     0,    0,    0,    0,    0,    0,    0,    0,    0,    0,     0,     0,     0,    1e-12, 0,
                                                     0,    0,    0,    0,    0,    0,    0,    0,    0,    0,     0,     0,     0,    0,    1e-12]</rosparam>




    </node>

    <!-- RVIZ -->
     <node type="rviz" name="rviz" pkg="rviz" args="-d $(find inspectrone_test)/rviz/fused_odometry.rviz" if="$(arg display_rviz)"/>
    <!-- Recrod new bag -->
    <node pkg="rosbag" type="record" name="rosbag_simulation"
        args="record -O /home/giacomo/inspectrone_ws/bags/inspectrone/filtered/$(arg output_bag_name) /tf /rovio/odometry /camera/odom/sample /camera/odom/sample_throttled /camera/gyro/imu_info /camera/imu /mavros/imu/data /mavros/imu/data_raw /mynteye/imu/data_raw /mynteye/imu/data_raw_processed /odometry/filtered"
        if="$(arg record_bag)" />
</launch>